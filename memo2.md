# AWS KMS を使用した証明書署名要求 (CSR) - コード構造の概要

このリポジトリは、AWS KMS の非対称鍵を使用して署名する証明書署名要求 (CSR) を作成する Java アプリケーションを含んでいます。

全体の構造と動作の仕組みを説明します：

## 主要コンポーネント

コードベースは主に 4 つの Java クラスで構成されています：

1. `CsrCreator` - CSR 作成プロセス全体を統括するメインクラス
2. `AwsKmsContentSigner` - AWS KMS を使用して署名するための BouncyCastle の ContentSigner インターフェースを実装したクラス
3. `Config` - JSON からロードされた設定データを扱うクラス
4. `GenerateCDPSample` - 証明書配布ポイント (CDP) の ASN.1 構造を生成するヘルパークラス

## システムの動作の仕組み

### 設定

アプリケーションは JSON ファイル (`cfg/kmscsr.json`) から設定を読み込みます。この設定には以下が含まれています：
- AWS KMS キー ARN
- AWS キー仕様 (現在は ECC_NIST_P256 のみサポート)
- 証明書のコモンネーム
- 証明書の国コード

### 処理フロー

1. **初期化と設定の読み込み**：
   - `CsrCreator` は BouncyCastle セキュリティプロバイダを初期化します
   - JSON ファイルから設定を読み込み、検証します

2. **公開鍵の取得**：
   - アプリケーションは設定された認証情報を使用して AWS KMS に接続します
   - 設定で指定された KMS キー ARN に関連付けられた公開鍵を取得します

3. **CSR の作成**：
   - コモンネーム (CN) と国 (C) の属性を持つ X.500 名を作成します
   - X.500 名と KMS からの公開鍵を使用して CSR ビルダーを作成します
   - BasicConstraints 拡張 (非 CA 証明書) を追加します

4. **CSR への署名**：
   - `AwsKmsContentSigner` を使用して CSR に署名します
   - `getSignature()` が呼び出されると、CSR データは署名のために AWS KMS に送信されます
   - KMS は秘密鍵を使用して署名操作を実行します（秘密鍵は AWS KMS から外部に出ることはありません）

5. **PEM フォーマット**：
   - 署名された CSR は PEM ファイルとしてフォーマットされます
   - 結果は出力用の文字列として返されます

## 主要クラスの詳細

### `CsrCreator`

これは `main()` メソッドを持つメインクラスです。このクラスは：
- ロギングの設定
- 設定の読み込みと検証
- AWS KMS への接続と公開鍵の取得
- CSR 構造の作成
- AWS KMS ContentSigner を使用した署名
- 出力の PEM フォーマット化

を行います。

### `AwsKmsContentSigner`

このクラスは BouncyCastle の `ContentSigner` インターフェースを実装し、AWS KMS での署名を可能にします：
- 署名するデータを `ByteArrayOutputStream` に収集します
- 署名が要求されると、データを AWS KMS に送信して署名します
- AWS KMS 署名アルゴリズム名と BouncyCastle アルゴリズム識別子の間のマッピングを行います

### `Config`

JSON ファイルから設定を読み込むための GSON アノテーションを持つシンプルな POJO クラスです。

## アプリケーションの実行方法

このアプリケーションは Maven を使用してビルドされ、以下のコマンドで実行できます：

```bash
mvn clean && mvn compile && mvn exec:java
```

前提条件：

- KMS 権限を持つ AWS 認証情報が設定されていること
- Java 開発キット
- Maven
- 正しく設定された `cfg/kmscsr.json` ファイル

## ユースケース

このコードは特に以下の場合に有用です：

1. 信頼できる認証局による署名が必要な証明書の CSR を作成する
2. AWS KMS (FIPS 140-2 準拠のハードウェアセキュリティモジュール) に秘密鍵を安全に保管する
3. 以下のようなアプリケーション用の安全な証明書インフラストラクチャを構築する：
   - SSL/TLS 証明書を必要とする Web サーバー
   - コード署名証明書
   - `memo.md` ファイルに記載されているモバイル運転免許証 (mDL) インフラなど

このアプリケーションは ECC_NIST_P256 キーと ECDSA_SHA_256 署名アルゴリズムをサポートしていますが、他のキー仕様もサポートするように拡張できます。